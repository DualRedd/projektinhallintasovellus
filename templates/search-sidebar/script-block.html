<script>
document.querySelectorAll('.task-summary button.detail-toggle').forEach(button => {
  button.addEventListener('click', function () {
    const summary = this.parentElement;
    const details = summary.nextElementSibling;
    summary.style.display = 'none';
    details.style.display = 'contents';
  });
});
document.querySelectorAll('.task-details button.detail-toggle').forEach(button => {
  button.addEventListener('click', function () {
    const details = this.parentElement;
    const summary = details.previousElementSibling;
    summary.style.display = 'contents';
    details.style.display = 'none';
  });
});
function enableStateEditMode(button){
    console.log("HELLO");
    const parent = button.closest(".task-details");
    parent.querySelector(".state-field").style.display = "none";
    parent.querySelector("form").style.display = "block";
    button.parentElement.style.display = "none";
    button.parentElement.nextElementSibling.style.display = "block";
}
function resetStateEditMode(button){
    const parent = button.closest(".task-details");
    parent.querySelector(".buttons-1").style.display = "block";
    parent.querySelector(".buttons-2").style.display = "none";
    parent.querySelector(".state-field").style.display = "block";
    parent.querySelector("form").style.display = "none";
    const select = parent.querySelector("form select");
    const optionToSelect = select.querySelector("option[value='" + select.dataset.value + "']");
    optionToSelect.selected = true;
}
function submitStateForm(button){
    const parent = button.closest(".task-details");
    parent.querySelector("form").submit();
}



const container = document.querySelector('.draggable-container');
container.addEventListener('dragstart', element => {
    if (element.target.classList.contains('draggable-item')) {
        element.target.classList.add('dragging');
    }
});
container.addEventListener('dragend', element => {
    if (element.target.classList.contains('draggable-item')) {
        element.target.classList.remove('dragging');
    }
});
container.addEventListener('dragover', element => {
    const draggingElement = document.querySelector('.dragging');
    const nextElement = getElementBelowDrag(container, element.clientY);
    if (nextElement == null) {
        container.appendChild(draggingElement);
    } else {
        container.insertBefore(draggingElement, nextElement);
    }
});

// Helper function to get the nearest element below the dragged position
function getElementBelowDrag(container, y) {
    const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - (box.top + box.height / 2);
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}
function orderDragElements(order){
    const dragElements = [...container.querySelectorAll('.draggable-item')];
    for(let i = 0; i < order.length; i++){
        const dragElement = dragElements.find(item => item.querySelector("input").value === order[i]);
        container.appendChild(dragElement);
    }
}

const searchForm = document.getElementById("search-form");
function saveUIState(){
    let dropdownState = [];
    searchForm.querySelectorAll(".dropdown").forEach(element => {
        dropdownState.push(element.querySelector(".dropdown-item-container").style.display);
    });
    sessionStorage.setItem("dropdownState", JSON.stringify(dropdownState));
    sessionStorage.setItem("sidebarActivate", true);
}
function submitSearchForm(){
    saveUIState();
    searchForm.submit();
}

orderDragElements({{request.args.getlist("sort")|tojson}});
const dropdownState = JSON.parse(sessionStorage.getItem("dropdownState"));
if(dropdownState !== null){
    sessionStorage.removeItem("dropdownState")
    dropdowns = searchForm.querySelectorAll(".dropdown");
    for(let i = 0; i < dropdowns.length; i++){
        if(dropdownState[i] == 'block'){
            toggleDropdown(dropdowns[i].querySelector("button"));
        }
    }
}
const openSidebar =  sessionStorage.getItem("sidebarActivate");
if(openSidebar !== null){
    sessionStorage.removeItem("sidebarActivate")
    toggleRightSidebar(true);
}

</script>